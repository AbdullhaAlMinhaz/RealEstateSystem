@model RealEstateSystem.ViewModels.AdminReportsViewModel

@{
    Layout = "_AdminLayout";
    ViewData["PageTitle"] = "Reports";
    ViewData["PageSubtitle"] = "Generate insights and activity reports.";

    string currentReport = (Model.ActiveReport ?? "sales").ToLower();
}

<style>
    .report-page {
        display: flex;
        flex-direction: column;
        gap: 1.75rem;
    }

    .report-overview {
        display: grid;
        grid-template-columns: repeat(3,minmax(0,1fr));
        gap: 1.25rem;
    }

    .report-card-main {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .stat-card.report-stat {
        position: relative;
        overflow: hidden;
        cursor: pointer;
        text-decoration: none;
        color: inherit;
    }

        .stat-card.report-stat .stat-label {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            opacity: 0.8;
        }

        .stat-card.report-stat .stat-meta {
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

    .trend-pill {
        position: absolute;
        right: 1rem;
        top: 1rem;
        font-size: 0.75rem;
        padding: 0.15rem 0.55rem;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .trend-up {
        background: rgba(46,213,115,0.12);
        color: #1f9254;
    }

    .trend-down {
        background: rgba(230,73,128,0.12);
        color: #c0395e;
    }

    .trend-arrow {
        font-size: 0.9rem;
    }

    .report-filters-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        margin-top: 0.5rem;
    }

    .report-filters-left {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        align-items: center;
    }

    .filter-select, .filter-input {
        border-radius: 999px;
        border: 1px solid #e0e4f2;
        padding: 0.4rem 0.9rem;
        font-size: 0.85rem;
        background-color: #f9fbff;
        outline: none;
    }

        .filter-select:focus, .filter-input:focus {
            border-color: #4f8bff;
            box-shadow: 0 0 0 3px rgba(79,139,255,0.18);
            background-color: #ffffff;
        }

    .report-type-tabs {
        display: inline-flex;
        background: #f3f6ff;
        border-radius: 999px;
        padding: 0.15rem;
        gap: 0.15rem;
    }

    .report-tab {
        border: none;
        background: transparent;
        padding: 0.35rem 0.85rem;
        font-size: 0.8rem;
        border-radius: 999px;
        cursor: pointer;
        color: #5b668c;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
    }

        .report-tab.is-active {
            background: #ffffff;
            box-shadow: 0 4px 12px rgba(82,101,255,0.18);
            color: #2741ff;
            font-weight: 500;
        }

    .report-main-grid {
        display: grid;
        grid-template-columns: minmax(0,1.5fr) minmax(0,1fr);
        gap: 1.75rem;
        margin-top: 0.25rem;
    }

    .table-compact .table th, .table-compact .table td {
        padding-top: 0.55rem;
        padding-bottom: 0.55rem;
        font-size: 0.85rem;
    }

    .quick-stat-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .quick-stat-item {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 0.75rem;
    }

    .quick-stat-label {
        font-size: 0.85rem;
        color: #6d7393;
    }

    .quick-stat-value {
        font-size: 0.95rem;
        font-weight: 600;
        color: #1d2340;
    }

    .quick-stat-note {
        font-size: 0.75rem;
        color: #9aa3c3;
        margin-top: 0.15rem;
    }

    .legend-dot-small {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.35rem;
    }

    .legend-new {
        background: #4f8bff;
    }

    .legend-sold {
        background: #2ecc71;
    }

    .legend-cancelled {
        background: #e74c3c;
    }
</style>

<section class="report-page">

    <!-- TOP SUMMARY CARDS (CLICKABLE) -->
    <section class="report-overview">
            
        <a class="stat-card report-stat"
           asp-action="RevenueDetails"
           asp-controller="AdminReports"
           asp-route-range="@Model.Range"
           asp-route-startDate="@Model.StartDate.ToString("yyyy-MM-dd")"
           asp-route-endDate="@Model.EndDate.ToString("yyyy-MM-dd")">


            <p class="stat-label">Total Revenue</p>
            <p class="stat-value">৳ @Model.TotalRevenue.ToString("N0")</p>
            <p class="stat-meta">Commission earned from confirmed sales</p>

            @{
                var revUp = Model.RevenueChangePercent >= 0;
                var revClass = revUp ? "trend-up" : "trend-down";
                var revArrow = revUp ? "▲" : "▼";
            }
            <div class="trend-pill @revClass">
                <span class="trend-arrow">@revArrow</span>
                <span>@Model.RevenueChangePercent.ToString("0.##")% vs prev</span>
            </div>
        </a>

        @* <a class="stat-card report-stat" asp-action="Index" asp-controller="AdminReports" asp-route-report="sales" asp-route-range="@Model.Range"> *@
            
        <a class="stat-card report-stat"
           asp-action="SalesDetails"
           asp-controller="AdminReports"
           asp-route-range="@Model.Range"
           asp-route-startDate="@Model.StartDate.ToString("yyyy-MM-dd")"
           asp-route-endDate="@Model.EndDate.ToString("yyyy-MM-dd")">

            
            <p class="stat-label">Completed Sales</p>
            <p class="stat-value">@Model.CompletedSales</p>
            <p class="stat-meta">Properties marked as sold in this period</p>

            @{
                var salesUp = Model.SalesChangeValue >= 0;
                var salesClass = salesUp ? "trend-up" : "trend-down";
                var salesArrow = salesUp ? "▲" : "▼";
            }
            <div class="trend-pill @salesClass">
                <span class="trend-arrow">@salesArrow</span>
                <span>@(salesUp ? "+" : "")@Model.SalesChangeValue deals</span>
            </div>
        </a>


        <a class="stat-card report-stat"
           asp-action="ListingsDetails"
           asp-controller="AdminReports"
           asp-route-range="@Model.Range"
           asp-route-startDate="@Model.StartDate.ToString("yyyy-MM-dd")"
           asp-route-endDate="@Model.EndDate.ToString("yyyy-MM-dd")">

            
            <p class="stat-label">New Listings</p>
            <p class="stat-value">@Model.NewListings</p>
            <p class="stat-meta">Fresh properties published by sellers</p>

            @{
                var listUp = Model.ListingsChangePercent >= 0;
                var listClass = listUp ? "trend-up" : "trend-down";
                var listArrow = listUp ? "▲" : "▼";
            }
            <div class="trend-pill @listClass">
                <span class="trend-arrow">@listArrow</span>
                <span>@Model.ListingsChangePercent.ToString("0.##")% vs prev</span>
            </div>
        </a>
    </section>

    <!-- FILTER BAR (GET FORM) -->
    <section class="card">
        <div class="card-header">
            <div class="report-card-main">
                <div>
                    <h2>Listing &amp; Sales Reports</h2>
                    <p class="card-subtitle">
                        Filter system activity by time range and report type.
                    </p>
                </div>

                <form class="report-filters-bar" method="get" asp-action="Index" asp-controller="AdminReports">
                    <div class="report-filters-left">
                        <select class="filter-select" id="rangeFilter" name="range">
                            <option value="7" selected="@(Model.Range == "7")">Last 7 days</option>
                            <option value="30" selected="@(Model.Range == "30")">Last 30 days</option>
                            <option value="90" selected="@(Model.Range == "90")">Last 3 months</option>
                            <option value="365" selected="@(Model.Range == "365")">Last 12 months</option>
                            <option value="custom" selected="@(Model.Range == "custom")">Custom range</option>
                        </select>

                        <input type="date" class="filter-input" id="fromDate" name="startDate" value="@Model.StartDate.ToString("yyyy-MM-dd")" />
                        <span style="font-size:0.8rem;color:#7b84a4;">to</span>
                        <input type="date" class="filter-input" id="toDate" name="endDate" value="@Model.EndDate.ToString("yyyy-MM-dd")" />

                        <input type="hidden" name="report" value="@currentReport" />
                        <button type="submit" class="filter-select" style="cursor:pointer;">Apply</button>
                    </div>

                    <div class="report-type-tabs">
                        <a class="report-tab @(currentReport == "listings" ? "is-active" : "")"
                           asp-action="Index" asp-controller="AdminReports"
                           asp-route-report="listings" asp-route-range="@Model.Range"
                           asp-route-startDate="@Model.StartDate.ToString("yyyy-MM-dd")"
                           asp-route-endDate="@Model.EndDate.ToString("yyyy-MM-dd")">
                            Listings
                        </a>

                        <a class="report-tab @(currentReport == "sales" ? "is-active" : "")"
                           asp-action="Index" asp-controller="AdminReports"
                           asp-route-report="sales" asp-route-range="@Model.Range"
                           asp-route-startDate="@Model.StartDate.ToString("yyyy-MM-dd")"
                           asp-route-endDate="@Model.EndDate.ToString("yyyy-MM-dd")">
                            Sales
                        </a>

                        <a class="report-tab @(currentReport == "revenue" ? "is-active" : "")"
                           asp-action="Index" asp-controller="AdminReports"
                           asp-route-report="revenue" asp-route-range="@Model.Range"
                           asp-route-startDate="@Model.StartDate.ToString("yyyy-MM-dd")"
                           asp-route-endDate="@Model.EndDate.ToString("yyyy-MM-dd")">
                            Revenue
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- MAIN GRID -->
        <div class="card-body report-main-grid">
            <!-- LEFT: TABLE -->
            <div class="table-wrapper table-compact">
                <table class="table" id="reportTable">
                    <thead>
                        <tr>
                            <th>Period</th>
                            <th>New listings</th>
                            <th>Sold</th>
                            <th>Cancelled</th>
                            <th>Conversion</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Rows != null && Model.Rows.Any())
                        {
                            foreach (var row in Model.Rows)
                            {
                                <tr>
                                    <td>@row.PeriodLabel</td>
                                    <td>@row.NewListings</td>
                                    <td>@row.Sold</td>
                                    <td>@row.Cancelled</td>
                                    <td>@row.ConversionPercent%</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="5">No report data found for this range.</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- RIGHT: QUICK STATS -->
            <aside>
                <h3 style="font-size:1rem;font-weight:600;margin-bottom:0.7rem;">Quick insights</h3>
                <ul class="quick-stat-list">
                    <li class="quick-stat-item">
                        <div>
                            <div class="quick-stat-label">Highest performing period</div>
                            <div class="quick-stat-note">Based on conversion of listings to sales</div>
                        </div>
                        <div class="quick-stat-value">@Model.BestPeriodLabel · @Model.BestPeriodConversion%</div>
                    </li>

                    <li class="quick-stat-item">
                        <div>
                            <div class="quick-stat-label">Average time to sell</div>
                            <div class="quick-stat-note">From listing creation to marked as sold</div>
                        </div>
                        <div class="quick-stat-value">@Model.AvgTimeToSellDays days</div>
                    </li>

                    <li class="quick-stat-item">
                        <div>
                            <div class="quick-stat-label">Top category this period</div>
                            <div class="quick-stat-note">By number of sold properties</div>
                        </div>
                        <div class="quick-stat-value">@Model.TopCategory</div>
                    </li>

                    <li class="quick-stat-item">
                        <div>
                            <div class="quick-stat-label">Activity breakdown</div>
                            <div class="quick-stat-note">New vs sold vs cancelled</div>
                        </div>
                        <div>
                            <span class="legend-dot-small legend-new"></span>
                            <span style="font-size:0.8rem;margin-right:0.4rem;">New (@Model.ActivityNew)</span>
                            <span class="legend-dot-small legend-sold"></span>
                            <span style="font-size:0.8rem;margin-right:0.4rem;">Sold (@Model.ActivitySold)</span>
                            <span class="legend-dot-small legend-cancelled"></span>
                            <span style="font-size:0.8rem;">Cancelled (@Model.ActivityCancelled)</span>
                        </div>
                    </li>
                </ul>
            </aside>
        </div>
    </section>
</section>

@section Scripts {
    <script>
        const rangeFilter = document.getElementById("rangeFilter");
        const fromDate = document.getElementById("fromDate");
        const toDate = document.getElementById("toDate");

        function applyCustomToggle() {
            const isCustom = rangeFilter.value === "custom";
            fromDate.disabled = !isCustom;
            toDate.disabled = !isCustom;

            if (!isCustom) {
                // keep values but disable inputs
            }
        }

        if (rangeFilter) {
            rangeFilter.addEventListener("change", applyCustomToggle);
            applyCustomToggle();
        }
    </script>
}
