@model RealEstateSystem.ViewModels.AdminDashboardViewModel
@{
    Layout = "_AdminLayout";
    ViewData["PageTitle"] = "Dashboard";
    ViewData["PageSubtitle"] = "Overview of users, listings and system activity.";
}


<style>
    .pending-actions {
        white-space: nowrap;
        display: flex;
        gap: 0.35rem;
    }

        .pending-actions .inline-form {
            display: inline;
        }

    .btn-small {
        font-size: 0.75rem;
        padding: 0.2rem 0.55rem;
        border-radius: 999px;
    }

    .btn-danger {
        background-color: #ffe5e5;
        color: #c0392b;
    }

    .btn-secondary {
        background-color: #eef2ff;
        color: #344266;
    }

    .badge-approved {
        background: rgba(46, 213, 115, 0.12);
        color: #1f9254;
    }

    .badge-rejected {
        background: rgba(231, 76, 60, 0.12);
        color: #c0392b;
    }

    /* simple modal */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.55);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }

        .modal-overlay.is-visible {
            display: flex;
        }

    .modal-card {
        background: #ffffff;
        border-radius: 20px;
        max-width: 640px;
        width: 94%;
        padding: 1.5rem 1.75rem;
        box-shadow: 0 20px 50px rgba(15, 23, 42, 0.35);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .modal-title {
        font-size: 1.1rem;
        font-weight: 600;
    }

    .modal-close {
        border: none;
        background: transparent;
        font-size: 1.2rem;
        cursor: pointer;
        color: #64748b;
    }

    .modal-body-row {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
        font-size: 0.9rem;
        margin-bottom: 0.3rem;
    }

    .modal-label {
        color: #7b84a4;
        min-width: 110px;
    }

    .modal-value {
        font-weight: 500;
        color: #111827;
    }

    .card-tag-select {
        border: none;
        background: #eef2ff;
        color: #475569;
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 13px;
        outline: none;
        cursor: pointer;
    }

</style>


<!-- OVERVIEW CARDS -->
<section class="grid grid-4 overview">
    <article class="stat-card is-active"
             style="cursor:pointer;"
             onclick="window.location='@Url.Action("Index", "AdminUsers")'">
        <p class="stat-label">Total Users</p>
        <p class="stat-value" id="totalUsers"
           data-counter data-target="@Model.TotalUsers">
            @Model.TotalUsers
        </p>
        <p class="stat-meta">Admins, Sellers &amp; Buyers</p>
    </article>

    <article class="stat-card"
             style="cursor:pointer;"
             onclick="window.location='@Url.Action("Buyers", "AdminUsers")'">
        <p class="stat-label">Total Buyers</p>
        <p class="stat-value" id="totalBuyers"
           data-counter data-target="@Model.TotalBuyers">
            @Model.TotalBuyers
        </p>
        <p class="stat-meta">Registered customers</p>
    </article>

    <article class="stat-card"
             style="cursor:pointer;"
             onclick="window.location='@Url.Action("Sellers", "AdminUsers")'">
        <p class="stat-label">Total Sellers</p>
        <p class="stat-value" id="totalSellers"
           data-counter data-target="@Model.TotalSellers">
            @Model.TotalSellers
        </p>
        <p class="stat-meta">Agents &amp; property owners</p>
    </article>

    <article class="stat-card"
             style="cursor:pointer;"
             onclick="window.location='@Url.Action("ActiveListings", "AdminProperties")'">
        <p class="stat-label">Active Listings</p>
        <p class="stat-value" id="activeListings"
           data-counter data-target="@Model.ActiveListings">
            @Model.ActiveListings
        </p>
        <p class="stat-meta">Currently visible to buyers</p>
    </article>
</section>



<!-- MIDDLE ROW -->
<section class="grid grid-2 middle">
    <!-- Chart 1 -->
    <article class="card">
        <div class="card-header">
            <h2>Listing &amp; Sales Overview</h2>
            @* <span class="card-tag">Last 6 months</span> *@
            <form method="get" asp-controller="AdminDashboard" asp-action="Index">
                <select class="card-tag-select" name="months" onchange="this.form.submit()">
                    <option value="1" selected="@(Model.SelectedMonths == 1)">Last 1 month</option>
                    <option value="2" selected="@(Model.SelectedMonths == 2)">Last 2 months</option>
                    <option value="4" selected="@(Model.SelectedMonths == 4)">Last 4 months</option>
                    <option value="6" selected="@(Model.SelectedMonths == 6)">Last 6 months</option>
                    <option value="12" selected="@(Model.SelectedMonths == 12)">Last 1 year</option>
                </select>
            </form>

        </div>

        <div class="chart-sample">
            <div class="chart-legend">
                <span><span class="legend-dot legend-listings"></span> New listings</span>
                <span><span class="legend-dot legend-sold"></span> Sold properties</span>
            </div>

            <div class="chart-bars">
                @if (Model.ListingSalesLast6Months != null && Model.ListingSalesLast6Months.Any())
                {
                    foreach (var m in Model.ListingSalesLast6Months)
                    {
                        <div class="chart-col">
                            <div class="bar-group">
                                <div class="bar bar-listings" style="height:@(m.NewHeightPx)px;" title="New: @m.NewListings"></div>
                                <div class="bar bar-sold" style="height:@(m.SoldHeightPx)px;" title="Sold: @m.SoldListings"></div>
                            </div>
                            <span class="chart-label">@m.MonthLabel</span>
                        </div>
                    }
                }
                else
                {
                    <div style="color:#6b7280;font-size:0.85rem;">No data available.</div>
                }
            </div>
        </div>
    </article>

    <!-- Chart 2 -->
    <article class="card">
        <div class="card-header">
            <h2>Property Category Distribution</h2>
            <span class="card-tag">Current listings</span>
        </div>

        <div class="pie-wrapper">
            <div class="pie-chart" style="background:@Model.CategoryPieGradientCss;">
                <div class="pie-hole"></div>
            </div>

            <div class="pie-legend">
                @if (Model.CategoryDistribution != null && Model.CategoryDistribution.Any())
                {
                    foreach (var s in Model.CategoryDistribution)
                    {
                        <div class="legend-row">
                            <span class="legend-color @s.CssClass"></span>
                            <span class="legend-label">@s.Label</span>
                            <span class="legend-value">@s.Percent%</span>
                        </div>
                    }
                }
                else
                {
                    <div style="color:#6b7280;font-size:0.85rem;">No active listings.</div>
                }
            </div>
        </div>
    </article>
</section>


<!-- BOTTOM -->
<section class="bottom">
    <article class="card">
        <div class="card-header">
            <div>
                <h2>Pending Property Approvals</h2>
                <p class="card-subtitle">Review recent property submissions from sellers.</p>
            </div>
            <a asp-controller="AdminApprovals" asp-action="Pending" class="card-link">View all</a>
        </div>

        <div class="table-wrapper">
            <table class="table">
                <thead>
                    <tr>
                        <th>Property</th>
                        <th>Seller</th>
                        <th>Submitted</th>
                        <th>Status</th>
                        <th>Actions</th>

                        <div id="propertyModal" class="modal-overlay">
                            <div class="modal-card">
                                <div class="modal-header">
                                    <div class="modal-title" id="modalPropertyTitle">Property title</div>
                                    <button type="button" class="modal-close" id="propertyModalClose">&times;</button>
                                </div>
                                <div class="modal-body">
                                    <div class="modal-body-row">
                                        <div class="modal-label">Seller</div>
                                        <div class="modal-value" id="modalPropertySeller"></div>
                                    </div>
                                    <div class="modal-body-row">
                                        <div class="modal-label">Submitted</div>
                                        <div class="modal-value" id="modalPropertySubmitted"></div>
                                    </div>
                                    <div class="modal-body-row">
                                        <div class="modal-label">Status</div>
                                        <div class="modal-value" id="modalPropertyStatus"></div>
                                    </div>
                                    <div style="margin-top:0.8rem;font-size:0.8rem;color:#9aa3c3;">
                                        For full details, open the property in the Properties page.
                                    </div>
                                </div>
                            </div>
                        </div>


                    </tr>
                </thead>
                <tbody id="pendingPropertiesBody">
                    @if (Model.PendingApprovals != null && Model.PendingApprovals.Any())
                    {
                        foreach (var p in Model.PendingApprovals)
                        {
                            var statusClass = "badge-pending";
                            var statusText = "Waiting";

                            if (p.ApprovalStatus == RealEstateSystem.Models.PropertyApprovalStatus.Approved)
                            {
                                statusClass = "badge-approved";
                                statusText = "Approved";
                            }
                            else if (p.ApprovalStatus == RealEstateSystem.Models.PropertyApprovalStatus.Rejected)
                            {
                                statusClass = "badge-rejected";
                                statusText = "Rejected";
                            }

                            var submittedText = p.SubmittedAt.ToString("dd MMM yyyy, HH:mm");

                            <tr>
                                <td>@p.Title</td>
                                <td>@p.SellerName</td>
                                <td>@submittedText</td>
                                <td>
                                    <span class="badge @statusClass">@statusText</span>
                                </td>
                                <td class="pending-actions">
                                    <form asp-controller="AdminProperties"
                                          asp-action="Approve"
                                          asp-route-id="@p.PropertyId"
                                          method="post"
                                          class="inline-form"
                                          onsubmit="return confirm('Approve this property?');">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn-table btn-small">Approve</button>
                                    </form>

                                    <form asp-controller="AdminProperties"
                                          asp-action="Reject"
                                          asp-route-id="@p.PropertyId"
                                          method="post"
                                          class="inline-form"
                                          onsubmit="return confirm('Reject this property?');">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn-table btn-danger btn-small">Reject</button>
                                    </form>

                                    <button type="button"
                                            class="btn-table btn-secondary btn-small js-view-property"
                                            data-property-id="@p.PropertyId"
                                            data-property-title="@p.Title"
                                            data-property-seller="@p.SellerName"
                                            data-property-submitted="@submittedText"
                                            data-property-status="@statusText">
                                        View
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="5">No pending properties right now 🎉</td>
                        </tr>
                    }
                </tbody>


            </table>
        </div>
    </article>
</section>

@section Scripts {
    <script>
        // number counters for the four stat cards
        document.querySelectorAll("[data-counter]").forEach(counter => {
            const target = parseInt(counter.getAttribute("data-target")) || 0;
            let current = 0;
            const increment = Math.max(1, Math.ceil(target / 80));

            const update = () => {
                current += increment;
                if (current >= target) {
                    current = target;
                } else {
                    requestAnimationFrame(update);
                }
                counter.textContent = current.toLocaleString();
            };
            requestAnimationFrame(update);
        });

        // property preview modal
        const modal = document.getElementById("propertyModal");
        const modalTitle = document.getElementById("modalPropertyTitle");
        const modalSeller = document.getElementById("modalPropertySeller");
        const modalSubmitted = document.getElementById("modalPropertySubmitted");
        const modalStatus = document.getElementById("modalPropertyStatus");
        const modalClose = document.getElementById("propertyModalClose");

        document.querySelectorAll(".js-view-property").forEach(btn => {
            btn.addEventListener("click", () => {
                modalTitle.textContent = btn.getAttribute("data-property-title") || "";
                modalSeller.textContent = btn.getAttribute("data-property-seller") || "";
                modalSubmitted.textContent = btn.getAttribute("data-property-submitted") || "";
                modalStatus.textContent = btn.getAttribute("data-property-status") || "";
                modal.classList.add("is-visible");
            });
        });

        modalClose?.addEventListener("click", () => {
            modal.classList.remove("is-visible");
        });

        modal?.addEventListener("click", (e) => {
            if (e.target === modal) {
                modal.classList.remove("is-visible");
            }
        });
    </script>
}
